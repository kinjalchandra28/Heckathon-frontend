<div class="relative flex flex-col h-full min-h-[600px] bg-gray-50 overflow-hidden">
    <!-- Background -->
    <img src="assets/icons/chat-bg.svg" class="absolute inset-0 w-full h-full object-cover pointer-events-none" alt="">

    <!-- Chat Title Header -->
    @if (chatTitle && !chatLoading) {
        <div class="relative z-10 px-6 pt-6 pb-2">
            <h1 class="text-2xl font-semibold text-gray-900">Analysis: {{ chatTitle }}</h1>
            @if (formattedChatDate) {
                <p class="text-sm text-gray-500 mt-1">{{ formattedChatDate }}</p>
            }
        </div>
    }

    <!-- Loading Chat -->
    @if (chatLoading) {
        <div class="relative z-10 flex-1 flex items-center justify-center">
            <div class="flex items-center gap-2">
                <div class="flex gap-1">
                    <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
                    <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
                    <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
                </div>
                <span class="text-sm text-gray-500">Loading chat...</span>
            </div>
        </div>
    }

    <!-- Chat Messages -->
    @if (!chatLoading && messages.length) {
        <div class="relative z-10 flex-1 overflow-y-auto p-6 space-y-4" [class.pt-2]="chatTitle">
            @for (msg of messages; track $index) {
                <div class="flex" [class.justify-end]="msg.sender === 'user'">
                    <!-- User Message -->
                    @if (msg.sender === 'user') {
                        <div class="max-w-[70%] px-4 py-3 rounded-2xl bg-blue-600 text-white">
                            @if (msg.file) {
                                <div class="flex items-center gap-2 mb-2 bg-white/20 rounded-lg px-2 py-1">
                                    <img src="assets/icons/file.svg" class="w-5 h-5" alt="">
                                    <span class="text-sm">{{ msg.file.name }}.{{ msg.file.type }}</span>
                                </div>
                            }
                            @if (msg.text) {
                                <p class="m-0">{{ msg.text }}</p>
                            }
                        </div>
                    }

                    <!-- Agent Message -->
                    @if (msg.sender === 'agent') {
                        <div [class]="(msg.graphData || msg.metricsData || msg.graphUrl || msg.summaryData) ? 'w-full max-w-[95%]' : 'max-w-[85%]'">
                            <!-- Display summary data (recommendations + summary) -->
                            @if (msg.summaryData) {
                                <app-summary-response [data]="msg.summaryData"></app-summary-response>
                            }

                            <!-- Display graph from API URL -->
                            @if (msg.graphUrl) {
                                <div class="mt-4 p-4 bg-white rounded-2xl shadow-sm">
                                    <img [src]="msg.graphUrl" alt="Analysis Graph" class="w-full rounded-lg">
                                </div>
                            }

                            <!-- Display graph from local data (fallback) -->
                            @if (msg.graphData && !msg.graphUrl) {
                                <app-temperature-chart [data]="msg.graphData"></app-temperature-chart>
                            }

                            <!-- Display metrics/datapoints table -->
                            @if (msg.metricsData) {
                                <div class="mt-4">
                                    <app-metrics-table [data]="msg.metricsData"></app-metrics-table>
                                </div>
                            }

                            <!-- Display plain text if no structured data -->
                            @if (msg.text && !msg.summaryData && !msg.graphData && !msg.metricsData && !msg.graphUrl) {
                                <div class="px-4 py-3 rounded-2xl bg-white shadow-sm text-gray-800">
                                    <p class="m-0">{{ msg.text }}</p>
                                </div>
                            }
                        </div>
                    }
                </div>
            }

            <!-- Loading Indicator -->
            @if (isLoading) {
                <div class="flex">
                    <div class="px-4 py-3 rounded-2xl bg-white shadow-sm">
                        <div class="flex items-center gap-2">
                            <div class="flex gap-1">
                                <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
                                <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
                                <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
                            </div>
                            <span class="text-sm text-gray-500">Analyzing file...</span>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <!-- Content -->
    <div class="relative z-10 flex flex-col items-center w-full px-4 py-8" [class.flex-1]="!messages.length && !chatLoading" [class.justify-center]="!messages.length && !chatLoading">
        @if (!messages.length && !chatLoading) {
            <h1 class="text-2xl font-semibold text-gray-800 mb-8">What would you like to do?</h1>
        }

        <!-- Input Card -->
        <div class="w-full max-w-xl bg-white rounded-2xl shadow-lg p-4">
            <!-- File Chip -->
            @if (uploadedFile) {
                <div class="flex items-center gap-3 mb-3 w-fit bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
                    <img src="assets/icons/file.svg" class="w-8 h-8" alt="">
                    <div class="flex flex-col">
                        <span class="text-sm font-medium text-gray-800">{{ uploadedFile.name }}</span>
                        <span class="text-xs text-gray-500">{{ uploadedFile.type }}</span>
                    </div>
                    <button (click)="removeFile()" class="ml-2 text-gray-400 hover:text-gray-600">
                        <img src="assets/icons/close.svg" class="w-5 h-5" alt="Remove">
                    </button>
                </div>
            }

            <!-- Input -->
            <input type="text" [(ngModel)]="message"
                   (focus)="onInputFocus()" (blur)="onInputBlur()" (keyup.enter)="sendMessage()"
                   placeholder="Ask anything" class="w-full text-gray-700 placeholder-gray-400 outline-none text-base mb-3">

            <!-- Actions -->
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <!-- Plus Button -->
                    <button (click)="triggerFileUpload()"
                            class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                        <svg class="w-4 h-4 text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                    </button>
                    <!-- Menu Button -->
                    <!-- <button class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                        <svg class="w-4 h-4 text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button> -->
                </div>
                <!-- Send Button -->
                <button (click)="sendMessage()" [disabled]="!canSend"
                        class="w-9 h-9 flex items-center justify-center rounded-full border transition-all"
                        [class]="canSend ? 'bg-gray-100 border-gray-200 hover:bg-gray-200' : 'bg-white border-gray-200 cursor-not-allowed'">
                    <svg class="w-4 h-4 transition-all" [class]="canSend ? 'text-gray-600' : 'text-gray-300'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>

            <input #fileInput type="file" (change)="onFileSelected($event)" class="hidden" accept=".csv,.xlsx,.pdf,.txt">
        </div>

        <!-- Suggestions (visible on input focus) -->
        @if (showSuggestions) {
            <div class="mt-4 flex flex-col gap-2 w-full max-w-xl">
                @for (suggestion of suggestions; track suggestion) {
                    <button (click)="selectSuggestion(suggestion)"
                            class="text-left px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow text-gray-700 text-sm">
                        {{ suggestion }}
                    </button>
                }
            </div>
        }
    </div>
</div>
